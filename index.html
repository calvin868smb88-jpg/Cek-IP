<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Dashboard Multi-Fungsi</title>
    
    <style>
        /* ==================== A. CSS DASAR & CONTAINER APP ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #444;
        }

        #main-app-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container-small {
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        
        .app-container-large {
            width: 90%;
            max-width: 1200px; /* Tambah ukuran maksimal */
            height: 90vh;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
        }

        /* ==================== B. CSS LOGIN & REGISTER ==================== */
        .login-register-form h1 {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .link-switch {
            display: block;
            margin-top: 20px;
            color: #007bff;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }

        /* ==================== C. CSS DASHBOARD ==================== */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #e67e22;
            font-size: 20px;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            border-left: 5px solid transparent;
            transition: background-color 0.2s, border-left-color 0.2s;
        }

        .menu-item:hover {
            background-color: #34495e;
        }

        .menu-item.active {
            background-color: #34495e;
            border-left-color: #e67e22;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: #ecf0f1;
        }

        .content-panel {
            display: none;
        }
        
        /* Box info user */
        #user-info-box {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 2px solid #ccc;
            background-color: #f9f9f9;
        }

        /* Input dan Output Area */
        .tool-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .tool-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #e67e22;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
        }

        .btn-action {
            padding: 10px 20px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        .btn-action:hover {
            background-color: #27ae60;
        }

        #results, #crmOutput, #pgSoftOutput, #netWinOutput, #output {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 6px;
            white-space: pre-wrap;
            text-align: left;
            font-family: monospace;
        }

        /* Tabel CSS */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #e67e22;
            color: white;
        }
        .high-count {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        /* CSS Kelola User & Status */
        .user-management-container {
            display: flex;
            gap: 20px;
        }

        .user-form-area {
            flex: 1;
            min-width: 300px;
        }
        .user-table-area {
            flex: 2;
        }

        .status-approved { color: #28a745; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-rejected { color: #dc3545; font-weight: bold; }

        .btn-danger { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-warning { background-color: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* History IP */
        .history-raw-data {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
            display: block;
        }
        
        /* Aktivitas Global */
        .activity-log-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .activity-log-item:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #999;
            margin-right: 10px;
            font-size: 12px;
        }
        .log-type-auth { color: #007bff; font-weight: bold; }
        .log-type-admin { color: #dc3545; font-weight: bold; }
        .log-type-tool { color: #28a745; font-weight: bold; }

    </style>
</head>
<body>

    <div id="main-app-container" class="app-container-small">
        
        <div id="login-view" class="login-register-form">
            <h1>LOGIN DASHBOARD AGENT</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">LOGIN</button>
            </form>
            <a href="#" class="link-switch" onclick="showView('register-view'); return false;">Belum punya akun? DAFTAR DISINI</a>
        </div>

        <div id="register-view" style="display: none;" class="login-register-form">
            <h1>DAFTAR AKUN BARU</h1>
            <p style="font-size: 14px; color: #555;">Akun baru akan berstatus PENDING dan harus disetujui oleh Master/Admin.</p>
            <form id="register-form">
                <div class="form-group">
                    <label for="reg-username">Username</label>
                    <input type="text" id="reg-username" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" required>
                </div>
                <button type="submit" class="btn-primary" style="background-color: #e67e22;">DAFTAR</button>
            </form>
            <a href="#" class="link-switch" onclick="showView('login-view'); return false;">Sudah punya akun? KEMBALI KE LOGIN</a>
        </div>

        <div id="dashboard-view" style="display: none;">
            
            <div class="sidebar">
                <h2>APLIKASI AGENT V1.0</h2>
                
                <div id="menu-cek-ip" class="menu-item menu-kapten-hidden active" onclick="switchDashboardContent('cek-ip', this)">CEK IP LOGIN (CS)</div>
                <div id="menu-cek-to-crm" class="menu-item" onclick="switchDashboardContent('cek-to-crm', this)">CEK TO CRM (Semua)</div>
                <div id="menu-hitung-pg-soft" class="menu-item" onclick="switchDashboardContent('hitung-pg-soft', this)">HITUNG KEMENANGAN PG SOFT</div>
                <div id="menu-prediksi-bola" class="menu-item menu-kapten-hidden" onclick="switchDashboardContent('prediksi-bola', this)">PREDIKSI BOLA & TEMPLATE</div>
                <div id="menu-history-ip" class="menu-item menu-kapten-hidden" onclick="switchDashboardContent('history-ip', this)">RIWAYAT CEK IP</div>
                
                <div id="menu-aktivitas-global" class="menu-item" onclick="switchDashboardContent('aktivitas-global', this)">AKTIVITAS GLOBAL (Semua)</div>
                
                <div id="menu-kelola-user" class="menu-item menu-master-only" style="margin-top: 20px;" onclick="switchDashboardContent('kelola-user', this)">KELOLA USER & APPROVAL</div>
                
                <div class="menu-item" style="margin-top: auto; color: #f1c40f;" onclick="handleLogout()">LOGOUT</div>
            </div>

            <div class="main-content">
                
                <div id="user-info-box"></div> 
                
                <div id="content-cek-ip" class="content-panel">
                    <h2>CEK DUPLIKASI IP LOGIN</h2>
                    <div class="tool-section">
                        <h3>1. Tempelkan Data Log IP</h3>
                        <p>Format data yang diharapkan: `USERID [spasi] [spasi] IP_LOGIN` per baris.</p>
                        <textarea id="logInput" placeholder="Contoh:&#10;user001  192.168.1.1&#10;user002  192.168.1.2&#10;user003  192.168.1.1"></textarea>
                        <button class="btn-action" onclick="processData()">Klik Disini: PROSES & CEK IP</button>
                        <button class="btn-danger" style="margin-left: 10px;" onclick="window.resetInput()">Reset Input</button>
                    </div>
                    <div class="tool-section">
                        <h3>2. Hasil Analisis IP</h3>
                        <div id="results"><p>Tempelkan data Anda dan tekan "Klik Disini".</p></div>
                    </div>
                </div>

                <div id="content-cek-to-crm" class="content-panel" style="display:none;">
                    <h2>CEK TOTAL TURNOVER (TO) DARI LOG TRANSAKSI</h2>
                    <div class="tool-section">
                        <h3>1. Tempelkan Data Log Transaksi</h3>
                        <p>Tempelkan seluruh log transaksi (terutama yang mengandung kata "PERTARUHAN" / "BET").</p>
                        <textarea id="toInput" placeholder="Contoh:&#10;[2024-01-15 10:30:00] user001 - Pertaruhan 15000&#10;[2024-01-15 10:31:00] user002 - Pertaruhan 25,000&#10;[2024-01-15 10:32:00] user001 - Spin 5000"></textarea>
                        <button class="btn-action" onclick="processToData()">Klik Disini: PROSES & HITUNG TO</button>
                    </div>
                    <div class="tool-section">
                        <h3>2. Hasil Perhitungan TO</h3>
                        <div id="crmOutput"><p>Total TO (Turnover) akan ditampilkan di sini.</p></div>
                    </div>
                </div>

                <div id="content-hitung-pg-soft" class="content-panel" style="display:none;">
                    <h2>HITUNG KEMENANGAN BERSIH PG SOFT</h2>
                    <div class="tool-section">
                        <h3>1. Tempelkan Log Pembayaran (Win/Payout)</h3>
                        <p>Tempelkan hanya baris log yang mengandung kata "PEMBAYARAN".</p>
                        <textarea id="pgSoftInput" placeholder="Contoh:&#10;[2024-01-15 11:00:00] user001 - Pembayaran 12000 8000000&#10;[2024-01-15 11:05:00] user002 - Pembayaran 25000 5000000"></textarea>
                        <button class="btn-action" onclick="processPgSoftData()">PROSES & HITUNG TOTAL PEMBAYARAN</button>
                        <div id="pgSoftOutput" style="margin-top: 15px;"><p>Total Pembayaran (Win/Payout) akan ditampilkan di sini.</p></div>
                    </div>
                    <div class="tool-section">
                        <h3>2. Masukkan Nominal Normal Spin</h3>
                        <p>Masukkan total nominal Normal Spin (Bet yang kalah/keluar modal) yang relevan.</p>
                        <input type="text" id="normalSpinInput" placeholder="Contoh: 15000000 (tanpa titik atau koma jika menggunakan koma ribuan)">
                        <button class="btn-action" onclick="calculateNetWin()" style="background-color: #3498db;">HITUNG KEMENANGAN BERSIH</button>
                        <div id="netWinOutput" style="margin-top: 15px;"><p>Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).</p></div>
                    </div>
                </div>

                <div id="content-prediksi-bola" class="content-panel" style="display:none;">
                    <h2>BUAT TEMPLATE PREDIKSI BOLA</h2>
                    <div class="tool-section">
                        <h3>1. Tempelkan Data Pertandingan</h3>
                        <p>Format yang diharapkan: `[Nama Liga (Baris Sendiri)]` kemudian `DD/MM HH:MM WIB TimA vs TimB Skor`.</p>
                        <textarea id="input" placeholder="Contoh:&#10;LIGA PREMIER INGGRIS&#10;01/01 22:30 WIB Manchester City vs Arsenal 3:1&#10;02/01 01:00 WIB Liverpool vs Chelsea 2-2&#10;LA LIGA SPANYOL&#10;02/01 22:30 WIB Real Madrid vs Barcelona 2:1"></textarea>
                        <button class="btn-action" onclick="generateTable()">PROSES & BUAT TABEL</button>
                    </div>
                    <div class="tool-section">
                        <h3>2. Preview Hasil Tabel</h3>
                        <div id="output"><p>Tabel pertandingan akan tampil di sini.</p></div>
                    </div>
                    <div class="tool-section">
                        <h3>3. Salin HTML untuk Dipublikasikan</h3>
                        <textarea id="htmlOutput" style="min-height: 100px;" placeholder="HTML yang dapat disalin akan muncul di sini."></textarea>
                        <button class="btn-action" onclick="copyHTML()" style="background-color: #9b59b6;">SALIN SEMUA HTML</button>
                    </div>
                </div>

                <div id="content-history-ip" class="content-panel" style="display: none;">
                    <h2>RIWAYAT CEK IP</h2>
                    <div class="tool-section">
                        <h3>Log Pengecekan IP (Hanya Perangkat Ini)</h3>
                        <p>⚠️ Catatan: Riwayat IP ini hanya tersimpan di browser Anda (Local Storage).</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>User</th>
                                    <th>IP Unik</th>
                                    <th>IP High Risk</th>
                                    <th>Data Singkat</th>
                                </tr>
                            </thead>
                            <tbody id="history-table">
                                </tbody>
                        </table>
                        <button class="btn-danger" style="margin-top: 15px;" onclick="clearHistory()">HAPUS SEMUA RIWAYAT</button>
                    </div>
                </div>
                
                <div id="content-aktivitas-global" class="content-panel" style="display: none;">
                    <h2>LOG AKTIVITAS GLOBAL (Simulasi Sinkronisasi Server)</h2>
                    <div class="tool-section">
                        <h3>Riwayat Tindakan Semua User</h3>
                        <p>⚠️ **PENTING:** Untuk membuat ini bekerja lintas perangkat, Anda harus menghubungkan fungsi ini ke server/database nyata. Saat ini, hanya disimulasikan secara lokal.</p>
                        <div id="global-activity-log" style="background-color: white; border: 1px solid #ddd; max-height: 60vh; overflow-y: scroll;">
                            </div>
                        <button class="btn-danger" style="margin-top: 15px;" onclick="clearGlobalActivity()">HAPUS SEMUA LOG AKTIVITAS (Simulasi)</button>
                    </div>
                </div>

                <div id="content-kelola-user" class="content-panel" style="display: none;">
                    <h2>KELOLA USER & APPROVAL</h2>
                    <div class="user-management-container">
                        
                        <div class="tool-section user-form-area">
                            <h3>Tambah / Edit User</h3>
                            <form id="user-form">
                                <input type="hidden" id="user-id">
                                <div class="form-group">
                                    <label for="user-username">Username</label>
                                    <input type="text" id="user-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="user-email">Email (Opsional)</label>
                                    <input type="email" id="user-email">
                                </div>
                                <div class="form-group">
                                    <label for="user-password">Password (Isi hanya jika membuat baru atau mengubah)</label>
                                    <input type="password" id="user-password">
                                </div>
                                <div class="form-group">
                                    <label for="user-role">Role</label>
                                    <select id="user-role">
                                        <option value="MASTER">MASTER</option>
                                        <option value="CS">CS</option>
                                        <option value="KAPTEN">KAPTEN</option>
                                    </select>
                                </div>
                                <button type="submit" id="submit-user-btn" class="btn-primary">Tambah User</button>
                                <button type="button" id="cancel-edit-btn" class="btn-danger" style="display: none; width: auto; margin-top: 10px;" onclick="resetUserForm()">Batal Edit</button>
                            </form>
                        </div>

                        <div class="tool-section user-table-area">
                            <h3>Daftar Akun Agent</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tbody id="user-table">
                                        </tbody>
                                </table>
                        </div>
                    </div>
                </div>


            </div>
        </div>

    </div>

    <script>
        const mainAppContainer = document.getElementById('main-app-container');
        const THRESHOLD = 3; 
        
        let currentUsername = null;
        let currentUserRole = null; 
        let lastTotalPayout = 0; 
        
        // ======================================
        // DATA GLOBAL (SIMULASI DATABASE SERVER)
        // PENTING: Untuk benar-benar sinkron, ini harus diganti dengan API/Database
        // ======================================
        let globalState = JSON.parse(localStorage.getItem('DASHBOARD_GLOBAL_STATE')) || {
            users: [
                { id: 1, username: 'cg88', email: 'master@example.com', password: 'asd123', role: 'MASTER', status: 'APPROVED' },
                { id: 2, username: 'admin', email: 'admin@example.com', password: 'password123', role: 'MASTER', status: 'APPROVED' },
                { id: 3, username: 'testuser', email: 'test@example.com', password: 'password123', role: 'CS', status: 'APPROVED' },
                { id: 4, username: 'kapten', email: 'kapten@example.com', password: 'password123', role: 'KAPTEN', status: 'APPROVED' }
            ],
            nextUserId: 5,
            activities: [] // Log aktivitas global
        };

        // Simpan data global ke localStorage agar simulasi ini setidaknya persistent per browser
        // HANYA UNTUK SIMULASI LOKAL. JANGAN GUNAKAN INI UNTUK LINGKUNGAN PRODUKSI NYATA.
        function saveGlobalState() {
             localStorage.setItem('DASHBOARD_GLOBAL_STATE', JSON.stringify(globalState));
        }

        // ======================================
        // FUNGSI SIMULASI API (Akan diganti dengan Fetch() ke Server nyata)
        // ======================================

        async function fetchUsersFromAPI() {
            // Placeholder: Di server nyata, ini akan menjadi `fetch('/api/users')`
            return globalState.users;
        }

        async function saveUserToAPI(user, action) {
            // Placeholder: Di server nyata, ini akan menjadi `fetch('/api/users/save', { method: 'POST', body: JSON.stringify(user) })`
            if (action === 'CREATE') {
                user.id = globalState.nextUserId++;
                globalState.users.push(user);
                logActivity(`Akun baru (${user.username}) DIDAFTARKAN. Status: PENDING.`, 'AUTH');
            } else if (action === 'UPDATE') {
                 const index = globalState.users.findIndex(u => u.id === user.id);
                 if (index !== -1) {
                     Object.assign(globalState.users[index], user);
                 }
                 logActivity(`Master mengubah data user ${user.username}.`, 'ADMIN');
            } else if (action === 'DELETE') {
                 const index = globalState.users.findIndex(u => u.id === user.id);
                 if (index !== -1) {
                     globalState.users.splice(index, 1);
                 }
                 logActivity(`Master MENGHAPUS user ${user.username}.`, 'ADMIN');
            }
            saveGlobalState();
            return { success: true, user: user };
        }
        
        async function approveUserInAPI(id, newStatus) {
             const user = globalState.users.find(u => u.id === id);
             if (user) {
                 user.status = newStatus;
                 logActivity(`Master ${currentUsername} MENGUBAH status user ${user.username} menjadi ${newStatus}.`, 'ADMIN');
                 saveGlobalState();
                 return { success: true, user: user };
             }
             return { success: false };
        }
        
        async function fetchActivityFromAPI() {
            // Placeholder: Di server nyata, ini akan menjadi `fetch('/api/activities')`
            return globalState.activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }
        
        function formatHistoryTimestamp(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) { return dateString; }
            
            const dateOptions = { day: '2-digit', month: 'long', year: 'numeric' };
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const formattedDate = date.toLocaleDateString('id-ID', dateOptions);
            const formattedTime = `${hours}:${minutes}:${seconds}`;
            
            return `${formattedDate}, ${formattedTime}`; 
        }

        function logActivity(message, type) {
            const newEntry = {
                timestamp: new Date().toISOString(),
                username: currentUsername || 'UNKNOWN',
                message: message,
                type: type // 'AUTH', 'ADMIN', 'TOOL'
            };
            globalState.activities.unshift(newEntry);
            saveGlobalState();
        }
        window.logActivity = logActivity;

        // ======================================
        // A. Fungsi Navigasi & Utility
        // ======================================

        function showView(viewId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'none';

            if (viewId === 'dashboard-view') {
                mainAppContainer.className = 'app-container-large';
                updateSidebarVisibility(currentUserRole); 
                document.getElementById(viewId).style.display = 'flex'; 
            } else {
                mainAppContainer.className = 'app-container-small';
                document.getElementById(viewId).style.display = 'block'; 
            }
        }
        
        function updateSidebarVisibility(role) {
            const masterMenus = document.querySelectorAll('.menu-master-only');
            masterMenus.forEach(menu => {
                menu.style.display = (role === 'MASTER') ? 'block' : 'none';
            });

            const kaptenHiddenMenus = document.querySelectorAll('.menu-kapten-hidden');
            const kaptenHiddenVisibility = (role === 'KAPTEN') ? 'none' : 'block'; 
            kaptenHiddenMenus.forEach(menu => {
                menu.style.display = kaptenHiddenVisibility;
            });
            
            if (role === 'KAPTEN') {
                const activeMenu = document.querySelector('.menu-item.active');
                if (activeMenu && (activeMenu.id === 'menu-cek-ip' || activeMenu.id === 'menu-prediksi-bola')) {
                     const defaultMenu = document.getElementById('menu-cek-to-crm');
                     if (defaultMenu) {
                         switchDashboardContent('cek-to-crm', defaultMenu);
                     }
                }
            }
        }

        function updateUserInfoBox(username) {
            const box = document.getElementById('user-info-box');
            if (box && username) {
                box.innerHTML = `Anda login sebagai: <strong><span style="color: #007bff;">${username}</span></strong>`;
            } else if (box) {
                box.innerHTML = ''; 
            }
        }

        function switchDashboardContent(contentId, clickedElement) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');

            document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');
            const targetId = 'content-' + contentId;
            const targetPanel = document.getElementById(targetId);
            if (targetPanel) {
                targetPanel.style.display = 'block';
            }

            if (contentId === 'cek-ip') {
                 updateUserInfoBox(currentUsername); 
            } else {
                 updateUserInfoBox(null); 
            }
            
            if (contentId === 'kelola-user') {
                renderUserTable();
            } else if (contentId === 'history-ip') { 
                renderHistoryTable();
            } else if (contentId === 'aktivitas-global') {
                 renderGlobalActivity(); // <-- PANGGIL FUNGSI BARU
            }
        }

        function handleLogout() {
            logActivity(`${currentUsername} telah LOGOUT.`, 'AUTH');
            alert('Anda telah berhasil keluar (logout).');
            currentUsername = null; 
            currentUserRole = null;
            
            localStorage.removeItem('app_username');
            localStorage.removeItem('app_role');
            
            showView('login-view');
            window.resetInput(); 
        }
        window.handleLogout = handleLogout;


        // ======================================
        // B. Logika Cek IP & History IP
        // ======================================
        
        async function processData() {
            const rawData = document.getElementById('logInput').value;
            if (!rawData.trim()) {
                document.getElementById('results').innerHTML = "<p>⚠️ Harap tempelkan data terlebih dahulu.</p>";
                return;
            }
            const logData = parseRawData(rawData);
            const analysisResults = analyzeLoginData(logData);
            renderResults(analysisResults);
            
            saveHistory(rawData, analysisResults);
            logActivity(`Melakukan pengecekan IP. Ditemukan ${analysisResults.length} IP unik.`, 'TOOL');
        }
        window.processData = processData;
        
        function parseRawData(rawData) {
            const lines = rawData.trim().split('\n');
            const parsedData = [];
            lines.forEach(line => {
                const parts = line.trim().split(/\s{2,}|\t/);
                if (parts.length >= 3) {
                    const userId = parts[0].trim();
                    let ipLogin = parts[2].trim(); 
                    if (userId && ipLogin && ipLogin.match(/^(\d{1,3}\.){3}\d{1,3}$/)) {
                        parsedData.push({ userId, ipLogin });
                    }
                }
            });
            return parsedData;
        }

        function analyzeLoginData(data) {
            const ipCounts = {};
            data.forEach(log => {
                const ip = log.ipLogin;
                ipCounts[ip] = (ipCounts[ip] || 0) + 1;
            });
            const resultsArray = Object.keys(ipCounts).map(ip => ({
                ipAddress: ip,
                userCount: ipCounts[ip]
            }));
            resultsArray.sort((a, b) => b.userCount - a.userCount);
            return resultsArray;
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results');
            if (results.length === 0) {
                resultsDiv.innerHTML = "<p>Tidak ada data valid yang ditemukan setelah diproses. Harap cek kembali format data yang ditempelkan.</p>";
                return;
            }
            let html = `<h2>Hasil Analisis: ${results.length} IP Unik}</h2>`;
            html += `<p>Data diurutkan dari IP dengan User ID terbanyak. Status "CEK IP INI" jika hitungan >= **${THRESHOLD}**.</p>`;
            html += '<table>';
            html += '<thead><tr><th>IP Address</th><th>Total User ID Unik</th><th>Status</th></tr></thead>';
            html += '<tbody>';
            results.forEach(item => {
                const isHigh = item.userCount >= THRESHOLD;
                const rowClass = isHigh ? 'class="high-count"' : '';
                html += `<tr ${rowClass}>`;
                html += `<td>${item.ipAddress}</td>`;
                html += `<td>${item.userCount}</td>`;
                html += `<td>${isHigh ? '❌ CEK IP INI' : '✅ NORMAL'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        // --- LOGIKA HISTORY CEK IP (TETAP LOCAL STORAGE UNTUK PERANGKAT INI) ---
        
        function saveHistory(rawData, analysisResults) {
            const historyKey = 'ip_check_history';
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            const highCountIP = analysisResults.find(r => r.userCount >= THRESHOLD);
            const highIpInfo = highCountIP 
                ? `${highCountIP.ipAddress} (${highCountIP.userCount} user)` 
                : 'T/A';

            const newEntry = {
                timestamp: new Date().toISOString(), 
                username: currentUsername || 'UNKNOWN',
                uniqueIpCount: analysisResults.length,
                highIp: highIpInfo,
                rawData: rawData.substring(0, 200) + (rawData.length > 200 ? '...' : '')
            };

            history.unshift(newEntry); 

            if (history.length > 100) {
                history = history.slice(0, 100);
            }

            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        function renderHistoryTable() {
            const historyKey = 'ip_check_history';
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const tbody = document.getElementById('history-table').querySelector('tbody');
            
            tbody.innerHTML = ''; 

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada riwayat pengecekan IP yang tercatat di perangkat ini.</td></tr>';
                return;
            }

            history.forEach((entry, index) => {
                const formattedTime = formatHistoryTimestamp(entry.timestamp); 
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${entry.username}</td>
                    <td>${entry.uniqueIpCount}</td>
                    <td>${entry.highIp}</td>
                    <td><div class="history-raw-data">${entry.rawData}</div></td>
                `;
            });
        }
        window.renderHistoryTable = renderHistoryTable;

        function clearHistory() {
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA RIWAYAT CEK IP LOKAL?")) {
                const historyKey = 'ip_check_history';
                localStorage.removeItem(historyKey);
                alert("Semua riwayat pengecekan IP lokal telah berhasil dihapus.");
                renderHistoryTable(); 
            }
        }
        window.clearHistory = clearHistory;

        // ======================================
        // C. Logika CEK TO CRM 
        // ======================================
        
        function processToData() {
            const rawData = document.getElementById('toInput').value;
            const lines = rawData.toUpperCase().trim().split('\n');
            const crmOutput = document.getElementById('crmOutput');

            if (lines.length === 0 || rawData.trim().length === 0) {
                crmOutput.textContent = "⚠️ Masukkan data log transaksi terlebih dahulu untuk diproses.";
                return;
            }

            let totalTO = 0;
            let foundLines = 0;

            const betRegex = /PERTARUHAN\s*([\d\.,]+)/g; 
            const singleStringData = lines.join(' ');
            
            let match;
            while ((match = betRegex.exec(singleStringData)) !== null) {
                let amountString = match[1];
                let cleanAmountString = amountString.replace(/,/g, ''); 
                let amount = parseFloat(cleanAmountString);

                if (!isNaN(amount) && amount > 0) {
                    totalTO += amount;
                    foundLines++;
                }
            }
            
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedTotalTO = formatter.format(totalTO); 
            
            let outputText = `Total Nominal Pertaruhan (TO) Ditemukan:\n\n`;
            outputText += `==========================================\n`;
            outputText += `  Total TO (Nominal): ${formattedTotalTO}\n`;
            outputText += `  (Dihitung dari ${foundLines} transaksi 'Pertaruhan')\n`;
            outputText += `==========================================`;

            crmOutput.textContent = outputText;
            logActivity(`Menghitung TO sebesar ${formattedTotalTO} dari ${foundLines} transaksi.`, 'TOOL');
            alert(`✅ Total TO berhasil dihitung: ${formattedTotalTO}`);
        }
        window.processToData = processToData;


        // ======================================
        // D. Logika HITUNG KEMENANGAN PG SOFT 
        // ======================================
        
        function processPgSoftData() {
            const rawData = document.getElementById('pgSoftInput').value;
            const lines = rawData.toUpperCase().trim().split('\n').filter(l => l.trim().length > 0); 
            const pgSoftOutput = document.getElementById('pgSoftOutput');
            const netWinOutput = document.getElementById('netWinOutput');


            if (lines.length === 0) {
                pgSoftOutput.textContent = "⚠️ Masukkan data log transaksi PG Soft terlebih dahulu untuk diproses.";
                netWinOutput.textContent = "Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).";
                lastTotalPayout = 0;
                return;
            }

            let totalPayout = 0;
            let foundPayouts = 0;
            
            const payoutRegex = /PEMBAYARAN[\d\.,]+\s*([\d\.,]+)/; 

            lines.forEach(line => {
                if (line.includes('PEMBAYARAN')) {
                    const match = line.match(payoutRegex);
                    
                    if (match && match[1]) {
                        let amountString = match[1];
                        let cleanAmountString = amountString.replace(/,/g, ''); 
                        let amount = parseFloat(cleanAmountString);

                        if (!isNaN(amount) && amount > 0) {
                            totalPayout += amount;
                            foundPayouts++;
                        }
                    } else {
                        const parts = line.split(/[^\d\.,]+/g).filter(p => p.trim().length > 0); 
                        if (parts.length >= 2) {
                            let nominalIndex = parts.length - 2; 
                            let amountString = parts[nominalIndex];
                            let cleanAmountString = amountString.replace(/,/g, ''); 
                            let amount = parseFloat(cleanAmountString);
                            
                            if (!isNaN(amount) && amount > 0) {
                                totalPayout += amount;
                                foundPayouts++;
                            }
                        }
                    }
                }
            });
            
            lastTotalPayout = totalPayout; 
            
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedPayout = formatter.format(totalPayout);
            
            let outputText = `Total Nominal Pembayaran PG SOFT Ditemukan:\n\n`;
            outputText += `==========================================\n`;
            outputText += `  Total Pembayaran (Win/Payout): ${formattedPayout}\n`;
            outputText += `  (Dihitung dari ${foundPayouts} baris 'Pembayaran')\n`;
            outputText += `==========================================`;

            pgSoftOutput.textContent = outputText;
            logActivity(`Menghitung Payout PG Soft: ${formattedPayout} dari ${foundPayouts} baris.`, 'TOOL');
            alert(`✅ Total Pembayaran berhasil dihitung: ${formattedPayout}. Sekarang masukkan Nominal Normal Spin untuk menghitung Kemenangan Bersih.`);
            
            netWinOutput.textContent = "Hasil Kemenangan Bersih akan tampil di sini (Pembayaran - Normal Spin).";
        }
        window.processPgSoftData = processPgSoftData;
        
        
        function calculateNetWin() {
            const normalSpinInput = document.getElementById('normalSpinInput').value;
            const netWinOutput = document.getElementById('netWinOutput');
            
            if (lastTotalPayout === 0) {
                netWinOutput.textContent = "⚠️ ERROR: Harap proses data Pembayaran (Win/Payout) terlebih dahulu di kolom atas.";
                return;
            }
            
            if (!normalSpinInput.trim()) {
                netWinOutput.textContent = "⚠️ ERROR: Harap masukkan Nominal Total Normal Spin.";
                return;
            }

            const cleanNormalSpinString = normalSpinInput.replace(/,/g, ''); 
            const totalNormalSpin = parseFloat(cleanNormalSpinString);

            if (isNaN(totalNormalSpin) || totalNormalSpin < 0) {
                netWinOutput.textContent = "⚠️ ERROR: Nominal Total Normal Spin tidak valid. Harap masukkan angka yang benar.";
                return;
            }
            
            const totalNetWin = lastTotalPayout - totalNormalSpin;
            
            const formatter = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0,
            });

            const formattedNetWin = formatter.format(totalNetWin);
            
            let status = '';
            if (totalNetWin > 0) {
                status = `✅ PROFIT!`;
            } else if (totalNetWin < 0) {
                status = `❌ RUGI!`;
            } else {
                status = `± IMPAS`;
            }

            const formattedPayout = formatter.format(lastTotalPayout);
            const formattedNormalSpin = formatter.format(totalNormalSpin);

            let outputText = `==========================================\n`;
            outputText += `  Total Pembayaran : ${formattedPayout}\n`;
            outputText += `  Total Normal Spin: ${formattedNormalSpin}\n`;
            outputText += `------------------------------------------\n`;
            outputText += `  KEMENANGAN BERSIH: ${formattedNetWin} (${status})\n`;
            outputText += `==========================================`;
            
            netWinOutput.textContent = outputText;
            logActivity(`Menghitung Kemenangan Bersih PG Soft: ${formattedNetWin} (${status}).`, 'TOOL');
            alert(`✅ Kemenangan Bersih berhasil dihitung: ${formattedNetWin}`);
        }
        window.calculateNetWin = calculateNetWin;


        // ======================================
        // E. Logika Log Aktivitas Global (BARU)
        // ======================================
        
        async function renderGlobalActivity() {
             const activityLog = document.getElementById('global-activity-log');
             activityLog.innerHTML = 'Memuat log aktivitas (Simulasi dari "Database")...';
             
             const activities = await fetchActivityFromAPI();
             activityLog.innerHTML = ''; 

             if (activities.length === 0) {
                 activityLog.innerHTML = '<p style="padding: 15px; text-align: center;">Belum ada aktivitas yang tercatat.</p>';
                 return;
             }

             activities.forEach(activity => {
                 let typeClass = '';
                 switch(activity.type) {
                     case 'AUTH': typeClass = 'log-type-auth'; break;
                     case 'ADMIN': typeClass = 'log-type-admin'; break;
                     case 'TOOL': typeClass = 'log-type-tool'; break;
                 }
                 
                 const formattedTime = formatHistoryTimestamp(activity.timestamp); 

                 const item = document.createElement('div');
                 item.className = 'activity-log-item';
                 item.innerHTML = `
                     <span class="log-time">${formattedTime}</span>
                     <span class="${typeClass}">[${activity.username}]</span>: ${activity.message}
                 `;
                 activityLog.appendChild(item);
             });
        }
        window.renderGlobalActivity = renderGlobalActivity;
        
        function clearGlobalActivity() {
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA LOG AKTIVITAS GLOBAL? (Simulasi)")) {
                globalState.activities = [];
                saveGlobalState();
                alert("Semua log aktivitas global telah berhasil dihapus.");
                renderGlobalActivity();
            }
        }
        window.clearGlobalActivity = clearGlobalActivity;


        // ======================================
        // F. Logika CRUD User & Approval
        // ======================================
        
        async function renderUserTable() {
            const tbody = document.getElementById('user-table');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Memuat data user (Simulasi API)...</td></tr>';
            
            const users = await fetchUsersFromAPI();

            tbody.innerHTML = ''; 

            users.forEach(user => {
                const row = tbody.insertRow();
                
                let statusText = '';
                let statusClass = '';
                let actionButtons = '';

                switch (user.status) {
                    case 'APPROVED':
                        statusText = 'APPROVED';
                        statusClass = 'status-approved';
                        actionButtons = `<button class="btn-danger" style="width: auto; margin: 2px;" onclick="rejectUser(${user.id})">Tolak</button>`;
                        break;
                    case 'PENDING':
                        statusText = 'PENDING';
                        statusClass = 'status-pending';
                        actionButtons = `<button class="btn-warning" style="width: auto; margin: 2px;" onclick="approveUser(${user.id})">Setujui</button>`;
                        break;
                    case 'REJECTED':
                        statusText = 'REJECTED';
                        statusClass = 'status-rejected';
                        actionButtons = `<button class="btn-warning" style="width: auto; margin: 2px;" onclick="approveUser(${user.id})">Setujui</button>`;
                        break;
                    default:
                        statusText = 'UNKNOWN';
                        statusClass = '';
                        break;
                }
                
                // Tambahkan tombol Edit dan Hapus (Hanya jika user tidak mencoba menghapus dirinya sendiri)
                if (user.username !== currentUsername) {
                   actionButtons += `<button class="btn-primary" style="width: auto; background-color: orange; margin: 2px;" onclick="editUser(${user.id})">Edit</button>
                                     <button class="btn-danger" style="width: auto; margin: 2px;" onclick="deleteUser(${user.id})">Hapus</button>`;
                } else {
                   actionButtons += `(Akun Anda)`;
                }


                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td> 
                    <td class="${statusClass}">${statusText}</td>
                    <td>${actionButtons}</td>
                `;
            });
        }
        
        async function updateUserStatus(id, newStatus) {
             const result = await approveUserInAPI(id, newStatus);
             if (result.success) {
                 alert(`Status user ${result.user.username} berhasil diubah menjadi ${newStatus}.`);
                 renderUserTable();
             } else {
                 alert('Gagal mengubah status user.');
             }
        }

        function approveUser(id) {
             updateUserStatus(id, 'APPROVED');
        }
        window.approveUser = approveUser;

        function rejectUser(id) {
             updateUserStatus(id, 'REJECTED');
        }
        window.rejectUser = rejectUser;

        async function saveUser(event) {
            event.preventDefault(); 
            const id = document.getElementById('user-id').value;
            const username = document.getElementById('user-username').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;

            const userList = await fetchUsersFromAPI();

            if (id) {
                // UPDATE USER
                const userToUpdate = userList.find(u => u.id === parseInt(id));
                if (userToUpdate) {
                    userToUpdate.username = username;
                    userToUpdate.email = email;
                    userToUpdate.role = role;
                    if (password) {
                        userToUpdate.password = password;
                    }
                    await saveUserToAPI(userToUpdate, 'UPDATE');
                    alert(`User ${username} berhasil diperbarui.`);
                }
            } else {
                // CREATE NEW USER (VIA MASTER INPUT)
                if (!password) {
                     alert('Gagal: Password wajib diisi untuk user baru.');
                     return;
                }
                const newUser = {
                    username: username,
                    email: email || 'default@email.com', 
                    password: password,
                    role: role, 
                    status: 'APPROVED' 
                };
                await saveUserToAPI(newUser, 'CREATE');
                alert(`User ${username} berhasil ditambahkan.`);
            }

            resetUserForm();
            renderUserTable();
        }

        function editUser(id) {
            const user = globalState.users.find(u => u.id === id); // Ambil dari globalState untuk edit
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-password').value = ''; 
                document.getElementById('submit-user-btn').textContent = 'Simpan Perubahan';
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';
                document.getElementById('user-form').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        async function deleteUser(id) {
            const userList = await fetchUsersFromAPI();
            const user = userList.find(u => u.id === id);
            
            if (!user) return;

            if (confirm(`Apakah Anda yakin ingin menghapus user ${user.username}?`)) {
                if (user.role === 'MASTER' && userList.filter(u => u.role === 'MASTER').length <= 1) {
                    alert("Gagal: Harus ada minimal satu user MASTER.");
                    return;
                }
                
                await saveUserToAPI(user, 'DELETE');
                alert('User berhasil dihapus.');
                renderUserTable();
            }
        }

        function resetUserForm() {
            document.getElementById('user-id').value = '';
            document.getElementById('user-username').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = 'CS';
            document.getElementById('submit-user-btn').textContent = 'Tambah User';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        window.renderUserTable = renderUserTable;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.resetUserForm = resetUserForm;


        // ======================================
        // G. Logika Login dan Register
        // ======================================

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const users = await fetchUsersFromAPI(); // Ambil data terbaru dari simulasi server

            const user = users.find(u => u.username === username && u.password === password);

            if (!user) {
                alert('Login gagal! Username atau Password salah.');
                return;
            }
            
            if (user.status === 'PENDING') {
                alert('Login ditolak! Akun Anda masih berstatus PENDING (Menunggu Persetujuan Master).');
                return;
            }
            if (user.status === 'REJECTED') {
                 alert('Login ditolak! Akun Anda telah ditolak oleh Master.');
                 return;
            }
            
            currentUsername = user.username;
            currentUserRole = user.role;
            
            // Simpan sesi ke Local Storage (Ini tetap per-perangkat, wajar)
            localStorage.setItem('app_username', currentUsername);
            localStorage.setItem('app_role', currentUserRole);
            
            logActivity(`${currentUsername} berhasil LOGIN.`, 'AUTH');
            alert(`Login berhasil! Selamat datang, ${currentUsername} (${currentUserRole}).`);
            showView('dashboard-view');
            
            let defaultContentId;
            let defaultMenuElement;

            if (user.role === 'KAPTEN') {
                defaultContentId = 'cek-to-crm';
                defaultMenuElement = document.getElementById('menu-cek-to-crm');
            } else {
                defaultContentId = 'cek-ip';
                defaultMenuElement = document.getElementById('menu-cek-ip');
            }
            
            switchDashboardContent(defaultContentId, defaultMenuElement);
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value; 

            const users = await fetchUsersFromAPI();

            if (users.find(u => u.username === username)) {
                alert('Pendaftaran gagal. Username sudah digunakan.');
                return;
            }

            const newUser = {
                username: username,
                email: 'registered_without_email@default.com', 
                password: password,
                role: 'CS', 
                status: 'PENDING' 
            };

            await saveUserToAPI(newUser, 'CREATE'); 

            alert(`Pendaftaran berhasil! Akun ${username} berhasil dibuat. Status: MENUNGGU ACC Master...`);
            document.getElementById('register-form').reset();
            showView('login-view');
        }

        // ======================================
        // H. Inisialisasi Event Listener
        // ======================================

        document.addEventListener('DOMContentLoaded', () => {
            // Pastikan globalState diinisialisasi
            saveGlobalState(); 
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('user-form').addEventListener('submit', saveUser);
            
            window.resetInput = function() {
                document.getElementById('logInput').value = '';
                document.getElementById('results').innerHTML = '<p>Tempelkan data Anda dan tekan "Klik Disini".</p>';
            };
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F5' && document.getElementById('dashboard-view').style.display === 'flex') {
                    e.preventDefault();
                    window.resetInput();
                }
            });
            
            // Cek sesi login saat startup
            const storedUsername = localStorage.getItem('app_username');
            const storedRole = localStorage.getItem('app_role');

            if (storedUsername && storedRole) {
                currentUsername = storedUsername;
                currentUserRole = storedRole;
                
                let defaultContentId;
                let defaultMenuElement;
                
                if (currentUserRole === 'KAPTEN') {
                    defaultContentId = 'cek-to-crm';
                    defaultMenuElement = document.getElementById('menu-cek-to-crm');
                } else {
                    defaultContentId = 'cek-ip';
                    defaultMenuElement = document.getElementById('menu-cek-ip');
                }

                showView('dashboard-view');
                switchDashboardContent(defaultContentId, defaultMenuElement);

            } else {
                showView('login-view'); 
            }
        });
        
    </script>

</body>
</html>
