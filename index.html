<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Multi-Fungsi</title>
    <style>
        /* [CSS SAMA SEPERTI SEBELUMNYA] */
        /* ==================== A. CSS DASAR & BACKGROUND ==================== */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('https://infomancingduit.com/wp-content/uploads/2024/12/MANCING.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            display: flex;
            min-height: 100vh;
            color: #444;
        }
        /* ==================== BARU: CSS Login/Register ==================== */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .auth-box {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transition: all 0.5s ease;
        }
        .auth-box h2 {
            color: #FFD700;
            text-shadow: 0 0 5px #FFD700;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .auth-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .auth-box button {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        .auth-box button:hover {
            background-color: #218838;
        }
        .auth-box p {
            margin-top: 20px;
            color: #666;
        }
        .auth-box a {
            color: #007bff;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
        }
        .auth-box a:hover {
            text-decoration: underline;
        }
        /* ==================== B. CSS SIDEBAR/MENU ==================== */
        #sidebar {
            width: 250px;
            background-color: rgba(34, 34, 34, 0.95);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            color: white;
            z-index: 100;
        }
        #sidebar .logo {
            width: 80%;
            height: auto;
            margin: 0 auto 15px auto;
            display: block;
        }
        #sidebar h2 {
            text-align: center;
            color: #FFD700;
            margin-bottom: 30px;
            text-shadow: 0 0 5px #FFD700;
        }
        .menu-item {
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #333;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #555;
            color: #FFD700;
        }
        /* CSS Logout Button di Sidebar */
        #logout-btn {
            margin-top: auto;
            padding: 15px 20px;
            background-color: #dc3545;
            color: white;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            border-top: 1px solid #555;
        }
        #logout-btn:hover {
            background-color: #c82333;
        }
        /* ==================== C. CSS KONTEN UTAMA (Container) ==================== */
        #main-container {
            flex-grow: 1;
            margin-left: 250px;
            padding: 20px;
            box-sizing: border-box;
        }
        .content-panel {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* ==================== D. CSS CEK IP & HISTORY ==================== */
        h1 { color: #222; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        textarea#logInput { width: 100%; height: 200px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; }
        button#btn-cek-ip { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e0e6ed; }
        .high-count { background-color: #ffcccc; font-weight: bold; }
        #running-text { padding: 10px 0; margin-bottom: 20px; border-bottom: 2px solid #ccc; }
        .glowing-text {
            font-size: 1.5em; font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 1), 0 0 10px rgba(255, 255, 255, 0.8), 0 0 15px currentColor, 0 0 20px currentColor;
        }
        .status-cek { background-color: #ffcccc; font-weight: bold; } 
        .status-normal { background-color: #e8f5e9; } 

        /* ==================== E. CSS PREDIKSI BOLA ==================== */
        #content-prediksi-bola { background: rgba(0, 0, 0, 0.85); color: white; }
        #content-prediksi-bola h2 { color: #FFD700; text-shadow: 0 0 8px #FFD700, 0 0 15px #FFD700; margin-bottom: 20px; }
        #content-prediksi-bola textarea { width: calc(100% - 20px); height: 150px; margin-bottom: 10px; border-radius: 5px; padding: 10px; resize: vertical; background: #222; color: #eee; border: 1px solid #555; }
        #content-prediksi-bola button { background: #FFD700; color: black; border: none; padding: 10px 25px; margin: 5px; cursor: pointer; font-weight: bold; border-radius: 5px; transition: background 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 0 5px #FFD700; }
        #content-prediksi-bola button:hover { background: #FFE066; box-shadow: 0 0 10px #FFD700; }
        #htmlOutput { height: 300px; background: #111; color: #0f0; font-family: 'Consolas', 'Monaco', monospace; border: 1px solid #333; }
        .match-block { background: #1a1a1a; color: white; border-radius: 5px; margin: 25px auto; padding: 0; width: 100%; max-width: 700px; overflow: hidden; box-shadow: 0 0 15px rgba(0,0,0,0.7); }
        .match-block .league-title { background: #000000; color: #f6ff00; padding: 10px 15px; margin: 0; text-align: center; font-size: 1em; font-weight: bold; text-transform: uppercase; text-shadow: 0 0 6px #FFFF00; }
        .match-block thead th { background: #fffb00; color: #000; font-weight: bold; padding: 8px 12px; border: 1px solid #444; text-align: center; }
        .match-block tbody td { background: #111; color: #fff; padding: 8px 12px; border: 1px solid #444; text-align: center; }
        
        /* ==================== G. CSS USER MANAGEMENT ==================== */
        #content-users h2 { color: #8b0000; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #user-list table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #user-list th, #user-list td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        #user-list th { background-color: #f2f2f2; color: #333; font-weight: bold; }
        .master-role { background-color: #ffc; font-weight: bold; }
        .edit-user-btn { padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background-color 0.3s; }
        .edit-user-btn:hover { background-color: #0056b3; }
        #edit-form-container { border: 1px solid #ccc; padding: 20px; border-radius: 5px; margin-top: 20px; background-color: #f9f9f9; }
        #edit-form-container input[type="text"], #edit-form-container input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #edit-form-container button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* ==================== H. CSS TAMBAHAN IMPORT/EXPORT HISTORY ==================== */
        .history-tools { margin-bottom: 20px; display: flex; gap: 10px; }
        .history-tools label { font-weight: bold; padding-top: 8px; }
        .history-tools button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .history-tools button:hover { background-color: #0056b3; }
        #importFile { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

    </style>
</head>
<body>
    <div id="auth-container">
        <div id="login-box" class="auth-box" style="display: none;">
            <h2>LOGIN KE DASHBOARD</h2>
            <input type="text" id="loginUsername" placeholder="Username" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button onclick="loginUser()">LOGIN</button>
            <p id="loginMessage" style="color: red;"></p>
            <p>Belum punya akun? <a onclick="showRegister()">Daftar Sekarang</a></p>
        </div>

        <div id="register-box" class="auth-box">
            <h2>REGISTRASI AKUN BARU</h2>
            <input type="text" id="registerUsername" placeholder="Username Baru" required>
            <input type="password" id="registerPassword" placeholder="Password Baru" required>
            <button onclick="registerUser()">REGISTRASI</button>
            <p id="registerMessage" style="color: red;">Gagal menyimpan data. Coba lagi.</p>
            <p>Sudah punya akun? <a onclick="showLogin()">Login</a></p>
        </div>
    </div>
    <div id="sidebar" style="display: none;">
        <img src="https://i.postimg.cc/8PMP5890/logo.png" alt="Logo Mancing Duit" class="logo">

        <a href="#" class="menu-item active" data-content="cek-ip" id="menu-cek-ip">üîç Cek IP</a>
        <a href="#" class="menu-item" data-content="history-cek-ip" id="menu-history-cek-ip" style="display: none;">üìú HISTORY CEK IP</a>
        <a href="#" class="menu-item" data-content="prediksi-bola" id="menu-prediksi-bola">‚öΩ PREDIKSI BOLA</a>
        
        <a href="#" class="menu-item" data-content="users" id="menu-users" style="display: none;">üë®‚Äçüíª MANAJEMEN USER</a>

        <div id="logout-btn" onclick="logoutUser()">KELUAR (LOGOUT)</div>
    </div>
    <div id="main-container" style="display: none;">
        <div id="content-cek-ip" class="content-panel" style="display: block;">
            <div id="running-text">
                <marquee behavior="scroll" direction="left" scrollamount="10">
                    <span class="glowing-text">
                        <span style="color: #FF0000;">C</span> <span style="color: #FF00FF;">E</span> <span style="color: #00FFFF;">K</span> <span style="color: #00FF00;">&nbsp;IP</span> <span style="color: #0000FF;">&nbsp;S</span> <span style="color: #4B0082;">E</span> <span style="color: #FF0000;">T</span> <span style="color: #FF00FF;">I</span> <span style="color: #00FFFF;">A</span> <span style="color: #00FF00;">P</span> <span style="color: #0000FF;">&nbsp;1</span> <span style="color: #4B0082;">&nbsp;J</span> <span style="color: #FF0000;">A</span> <span style="color: #FF00FF;">M</span> <span style="color: #00FFFF;">&nbsp;S</span> <span style="color: #00FF00;">E</span> <span style="color: #0000FF;">K</span> <span style="color: #4B0082;">A</span> <span style="color: #FF0000;">L</span> <span style="color: #FF00FF;">I</span> </span>
                </marquee>
            </div>
            <h1>üîç Dashboard Analisis IP Login</h1>
            <p>‚úÖTempelkan data Anda di bawah ini. Tekan F5 untuk membersihkan input.</p>
            <textarea id="logInput" placeholder="Tempelkan data Anda di sini..."></textarea>
            <button onclick="processData()" id="btn-cek-ip">Klik Disini</button>
            <div id="results">
                <p>Tempelkan data Anda dan tekan "Klik Disini".</p>
            </div>
        </div>

        <div id="content-history-cek-ip" class="content-panel" style="display: none;">
            <h2>üìú Riwayat Pengecekan IP</h2>
            <p style="font-style: italic; color: #555;">(Data riwayat ini tersimpan lokal. Gunakan Import/Export untuk berbagi dengan Staff lain.)</p>
            
            <div class="history-tools">
                <button onclick="clearHistory()">Hapus Semua Riwayat</button>
                <button onclick="exportHistory()">Export Riwayat (.json)</button>
                <input type="file" id="importFile" accept=".json">
                <button onclick="importHistory()">Import Riwayat</button>
            </div>
            
            <div id="history-results">
                <p>Belum ada riwayat pengecekan IP yang tersimpan.</p>
            </div>
        </div>

        <div id="content-prediksi-bola" class="content-panel" style="display: none;">
            <h2>PREDIKSI BOLA</h2>
            <textarea id="input" placeholder="Masukkan pertandingan di sini..."></textarea><br>
            <button onclick="generateTable()">GENERATE TABEL</button>
            <button onclick="copyHTML()">COPY SEMUA HTML</button>
            <div id="output"></div>
            <h3 class="hasil-html">üìã Hasil HTML Disini:</h3>
            <textarea id="htmlOutput" readonly></textarea>
        </div>

        <div id="content-users" class="content-panel" style="display: none;">
            <h2>üë®‚Äçüíª Manajamen Data Staff</h2>
            <p style="color: red; font-weight: bold;">‚ö†Ô∏è HANYA ADMIN MASTER YANG BISA MELIHAT & MENGEDIT DATA INI.</p>
            
            <h3>Tambah/Edit Pengguna:</h3>
            <div id="add-user-form" style="border: 1px solid #ccc; padding: 20px; border-radius: 5px; margin-bottom: 20px; background-color: #f9f9f9;">
                <label for="newUserUsername">Username Staff Baru:</label>
                <input type="text" id="newUserUsername" placeholder="Username Staff" style="width: calc(50% - 10px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <label for="newUserPassword">Password:</label>
                <input type="password" id="newUserPassword" placeholder="Password Baru" style="width: calc(50% - 10px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="addNewStaff()" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Tambah Staff Baru</button>
                <p id="addUserMessage" style="color: green; margin-top: 10px;"></p>
            </div>


            <h3>Daftar Pengguna:</h3>
            <div id="user-list">
                <p>Memuat data pengguna...</p>
            </div>

            <div id="edit-form-container" style="display: none;">
                <h3>Edit Pengguna: <span id="editing-username-display" style="color: #007bff;"></span></h3>
                <label for="editPassword">Password Baru (Kosongkan jika tidak diubah):</label>
                <input type="password" id="editPassword" placeholder="Password Baru">
                
                <label for="editRole">Peran (Role):</label>
                <select id="editRole" style="padding: 10px; margin-bottom: 10px; width: 100%;">
                    <option value="staf">Staf</option>
                    <option value="master">Admin Master</option>
                </select>
                
                <button onclick="saveEditedUser()">Simpan Perubahan</button>
                <button style="background-color: #6c757d;" onclick="document.getElementById('edit-form-container').style.display = 'none';">Batal</button>
                <p id="editMessage" style="color: green; margin-top: 10px;"></p>
            </div>
        </div>
    </div>
    <script>
        // Key untuk menyimpan data user
        const USER_STORAGE_KEY = 'dashboardUsers';
        // Key untuk status login
        const LOGGED_IN_KEY = 'isLoggedIn';
        // Key untuk menyimpan riwayat di localStorage
        const HISTORY_STORAGE_KEY = 'ipCheckHistory';
        // Variabel global untuk menyimpan username yang sedang di-edit
        let editingUsername = null; 
        const THRESHOLD = 3;

        // ==================== A. FUNGSI UTAMA (Reset & Init) ====================

        function resetDashboardInputs() {
            const logInput = document.getElementById('logInput');
            if (logInput) logInput.value = '';
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) resultsDiv.innerHTML = '<p>Tempelkan data Anda dan tekan "Klik Disini".</p>';

            const inputPrediksi = document.getElementById('input');
            if (inputPrediksi) inputPrediksi.value = '';
            const outputPrediksi = document.getElementById('output');
            if (outputPrediksi) outputPrediksi.innerHTML = '';
            const htmlOutput = document.getElementById('htmlOutput');
            if (htmlOutput) htmlOutput.value = '';
            
            const registerUsername = document.getElementById('registerUsername');
            const registerPassword = document.getElementById('registerPassword');
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');

            if(registerUsername) registerUsername.value = '';
            if(registerPassword) registerPassword.value = '';
            if(loginUsername) loginUsername.value = '';
            if(loginPassword) loginPassword.value = '';
            
            const regMsg = document.getElementById('registerMessage');
            const logMsg = document.getElementById('loginMessage');
            if(regMsg) regMsg.textContent = '';
            if(logMsg) logMsg.textContent = '';
        }

        window.onload = function() {
            resetDashboardInputs(); 
            checkLoginStatus(); 
        };

        // ==================== B. AUTHENTICATION (Login/Register) ====================

        function showLogin() {
            const regBox = document.getElementById('register-box');
            const logBox = document.getElementById('login-box');
            if (regBox) regBox.style.display = 'none';
            if (logBox) logBox.style.display = 'block';
            resetDashboardInputs(); 
        }

        function showRegister() {
            const logBox = document.getElementById('login-box');
            const regBox = document.getElementById('register-box');
            if (logBox) logBox.style.display = 'none';
            if (regBox) regBox.style.display = 'block';
            resetDashboardInputs(); 
        }

        function getUsers() {
            try {
                const usersJson = localStorage.getItem(USER_STORAGE_KEY);
                return usersJson ? JSON.parse(usersJson) : {};
            } catch (e) {
                console.error("Gagal memuat pengguna:", e);
                return {};
            }
        }

        function registerUser() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const messageDiv = document.getElementById('registerMessage');

            messageDiv.style.color = 'red'; 
            messageDiv.textContent = '';

            if (username.length < 4 || password.length < 6) {
                messageDiv.textContent = 'Username minimal 4 karakter, Password minimal 6 karakter.';
                return;
            }

            const users = getUsers();

            if (users[username]) {
                messageDiv.textContent = 'Username sudah terdaftar. Silakan gunakan yang lain.';
                return;
            }

            // PENGATURAN ROLE: Pengguna pertama yang mendaftar menjadi 'master'
            const role = Object.keys(users).length === 0 ? 'master' : 'staf';

            users[username] = { password: password, role: role };

            try {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
                messageDiv.style.color = 'green';
                messageDiv.textContent = 'Registrasi Berhasil! Silakan Login.';
                
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                setTimeout(showLogin, 1500); 
            } catch (e) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = `‚ùå Gagal menyimpan data: ${e.name}. Coba lagi.`;
                console.error("LOCAL STORAGE ERROR:", e);
            }
        }

        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const messageDiv = document.getElementById('loginMessage');

            messageDiv.style.color = 'red';
            messageDiv.textContent = '';

            if (!username || !password) {
                messageDiv.textContent = 'Username dan Password harus diisi.';
                return;
            }

            const users = getUsers();
            const user = users[username];

            // PENTING: Pengecekan format user, jika hanya string (seperti error sebelumnya) ubah ke format objek
            if (user && typeof user === 'string') {
                user = { password: user, role: Object.keys(users).length === 1 ? 'master' : 'staf' };
                users[username] = user;
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users)); 
            }


            if (user && user.password === password) {
                localStorage.setItem(LOGGED_IN_KEY, 'true');
                localStorage.setItem('currentRole', user.role); 

                messageDiv.style.color = 'green';
                messageDiv.textContent = `Login Berhasil sebagai ${user.role.toUpperCase()}! Memuat Dashboard...`;
                setTimeout(checkLoginStatus, 500);
            } else {
                messageDiv.textContent = 'Username atau Password salah.';
            }
        }

        function logoutUser() {
            localStorage.removeItem(LOGGED_IN_KEY); 
            localStorage.removeItem('currentRole'); 
            
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('main-container').style.display = 'none';
            
            document.getElementById('menu-history-cek-ip').style.display = 'none';
            document.getElementById('menu-users').style.display = 'none';
            
            resetDashboardInputs(); 
            alert("Anda telah berhasil Logout.");
            showLogin();
        }

        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem(LOGGED_IN_KEY) === 'true';
            const currentRole = localStorage.getItem('currentRole'); 
            
            const authContainer = document.getElementById('auth-container');
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('main-container');
            
            const menuHistory = document.getElementById('menu-history-cek-ip');
            const menuUsers = document.getElementById('menu-users');

            if (isLoggedIn) {
                authContainer.style.display = 'none';
                sidebar.style.display = 'flex';
                mainContainer.style.display = 'block';

                // LOGIKA PEMBATASAN ROLE
                if (currentRole === 'master') {
                    // MASTER: Tampilkan semua menu
                    if (menuHistory) menuHistory.style.display = 'block';
                    if (menuUsers) menuUsers.style.display = 'block';
                } else if (currentRole === 'staf') {
                    // STAFF: Bisa lihat Cek IP, History, dan Prediksi
                    if (menuHistory) menuHistory.style.display = 'block'; // AKTIF UNTUK STAFF
                    if (menuUsers) menuUsers.style.display = 'none'; // Sembunyikan Manajamen User
                    
                    // Jika Staff sedang berada di konten Manajamen User, pindahkan ke Cek IP
                    const activeContent = document.querySelector('.content-panel:not([style*="display: none"])');
                    if (activeContent && activeContent.id === 'content-users') {
                         document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');
                         document.getElementById('content-cek-ip').style.display = 'block';
                         document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                         document.getElementById('menu-cek-ip').classList.add('active');
                    }
                }

                if (!document.querySelector('.content-panel:not([style*="display: none"])')) {
                    document.getElementById('content-cek-ip').style.display = 'block';
                    document.getElementById('menu-cek-ip').classList.add('active');
                }
                
            } else {
                authContainer.style.display = 'flex';
                sidebar.style.display = 'none';
                mainContainer.style.display = 'none';
                if (menuHistory) menuHistory.style.display = 'none';
                if (menuUsers) menuUsers.style.display = 'none';
                
                const users = getUsers();
                if (Object.keys(users).length === 0) {
                    showRegister();
                } else {
                    showLogin();
                }
            }
        }

        // ==================== C. MANAJEMEN MENU (CONTENT SWITCHING) ====================

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();

                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');

                const targetId = 'content-' + this.getAttribute('data-content');
                const targetPanel = document.getElementById(targetId);
                const currentRole = localStorage.getItem('currentRole');
                
                // Hanya Manajamen User yang membutuhkan role Master
                if (this.getAttribute('data-content') === 'users' && currentRole !== 'master') {
                    alert('Akses Ditolak! Menu ini hanya untuk Admin Master.');
                    document.getElementById('content-cek-ip').style.display = 'block';
                    document.getElementById('menu-cek-ip').classList.add('active');
                    return;
                }

                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }

                if (this.getAttribute('data-content') === 'history-cek-ip') {
                    loadHistory();
                }
                
                if (this.getAttribute('data-content') === 'users') {
                    if (currentRole === 'master') {
                        loadUserList();
                    }
                }
            });
        });

        // ==================== D. FUNGSI CEK IP ====================
        
        function processData() {
            const rawData = document.getElementById('logInput').value;

            if (!rawData.trim()) {
                document.getElementById('results').innerHTML = "<p>‚ö†Ô∏è Harap tempelkan data terlebih dahulu.</p>";
                return;
            }

            const logData = parseRawData(rawData);
            const analysisResults = analyzeLoginData(logData);
            renderResults(analysisResults);

            const highCountIPs = analysisResults.filter(item => item.userCount >= THRESHOLD);
            const status = highCountIPs.length > 0
                ? `‚ùå Ditemukan ${highCountIPs.length} IP di atas batas (${THRESHOLD} User ID)`
                : '‚úÖ Normal';

            saveHistory(status);
        }

        function parseRawData(rawData) {
            const lines = rawData.trim().split('\n');
            const parsedData = [];
            lines.forEach(line => {
                const parts = line.trim().split(/\s{2,}|\t/);
                if (parts.length >= 3) {
                    const userId = parts[0].trim();
                    const ipLogin = parts[2].trim();
                    if (userId && ipLogin && ipLogin.match(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/)) {
                        parsedData.push({ userId, ipLogin });
                    }
                } else if (parts.length >= 2 && parts[1].match(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/)) {
                    const userId = parts[0].trim();
                    const ipLogin = parts[1].trim();
                    if (userId && ipLogin) {
                        parsedData.push({ userId, ipLogin });
                    }
                }
            });
            return parsedData;
        }

        function analyzeLoginData(data) {
            const ipCounts = {};
            data.forEach(log => {
                const ip = log.ipLogin;
                ipCounts[ip] = (ipCounts[ip] || 0) + 1;
            });
            const resultsArray = Object.keys(ipCounts).map(ip => ({
                ipAddress: ip,
                userCount: ipCounts[ip]
            }));
            resultsArray.sort((a, b) => b.userCount - a.userCount);
            return resultsArray;
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results');
            if (results.length === 0) {
                resultsDiv.innerHTML = "<p>Tidak ada data valid yang ditemukan setelah diproses. Harap cek kembali format data yang ditempelkan.</p>";
                return;
            }
            let html = `<h2>Hasil Analisis: ${results.length} IP Unik</h2>`;
            html += `<p>Data diurutkan dari IP dengan User ID terbanyak. Status "CEK IP INI" jika hitungan >= ${THRESHOLD}.</p>`;
            html += '<table>';
            html += '<thead><tr><th>IP Address</th><th>Total User ID Unik</th><th>Status</th></tr></thead>';
            html += '<tbody>';
            results.forEach(item => {
                const isHigh = item.userCount >= THRESHOLD;
                const rowClass = isHigh ? 'class="high-count"' : '';
                html += `<tr ${rowClass}>`;
                html += `<td>${item.ipAddress}</td>`;
                html += `<td>${item.userCount}</td>`;
                html += `<td>${isHigh ? '‚ùå CEK IP INI' : '‚úÖ NORMAL'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        // ==================== E. FUNGSI RIWAYAT IP (Termasuk Import/Export) ====================

        function getHistory() {
            try {
                const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
                return historyJson ? JSON.parse(historyJson) : [];
            } catch (e) {
                console.error("Gagal memuat riwayat dari localStorage:", e);
                return [];
            }
        }

        function saveHistory(status) {
            const now = new Date();
            const date = now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const newEntry = {
                date: date,
                time: time,
                status: status
            };

            const history = getHistory();
            history.unshift(newEntry);

            const MAX_HISTORY = 50;
            if (history.length > MAX_HISTORY) {
                history.length = MAX_HISTORY;
            }

            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                console.error("Gagal menyimpan riwayat:", e);
            }
        }

        function loadHistory() {
            const history = getHistory();
            const historyDiv = document.getElementById('history-results');

            if (history.length === 0) {
                historyDiv.innerHTML = '<p>Belum ada riwayat pengecekan IP yang tersimpan.</p>';
                return;
            }

            let html = '<table>';
            html += '<thead><tr><th>Tanggal</th><th>Jam</th><th>Status Pengecekan</th></tr></thead>';
            html += '<tbody>';

            history.forEach(entry => {
                const rowClass = entry.status.startsWith('‚ùå') ? 'class="status-cek"' : 'class="status-normal"';
                html += `<tr ${rowClass}>`;
                html += `<td>${entry.date}</td>`;
                html += `<td>${entry.time}</td>`;
                html += `<td>${entry.status}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            historyDiv.innerHTML = html;
        }

        function clearHistory() {
             if (confirm("Apakah Anda yakin ingin menghapus semua riwayat pengecekan IP?")) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                loadHistory(); 
                alert("Riwayat berhasil dihapus!");
            }
        }
        
        // FUNGSI BARU: Export History (agar bisa dibagikan)
        function exportHistory() {
            const history = getHistory();
            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ip_check_history_' + new Date().toISOString().slice(0, 10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Riwayat berhasil diexport sebagai file JSON.');
        }

        // FUNGSI BARU: Import History (untuk memuat riwayat yang dibagikan)
        function importHistory() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                alert('Pilih file .json riwayat untuk diimpor.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const importedHistory = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedHistory) || importedHistory.some(item => !item.date || !item.status)) {
                        throw new Error("Format file JSON tidak valid untuk Riwayat IP.");
                    }
                    
                    if (confirm("Riwayat baru akan menimpa riwayat yang ada. Lanjutkan?")) {
                        // Batasi riwayat yang diimpor
                        const MAX_HISTORY = 50;
                        if (importedHistory.length > MAX_HISTORY) {
                            importedHistory.length = MAX_HISTORY;
                        }
                        
                        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(importedHistory));
                        loadHistory();
                        alert('Riwayat berhasil diimpor!');
                    }
                } catch (error) {
                    alert('Gagal mengimpor riwayat: ' + error.message);
                    console.error("IMPORT ERROR:", error);
                }
            };
            
            reader.readAsText(file);
        }

        // ==================== F. FUNGSI PREDIKSI BOLA ====================

        function generateTable() {
            const input = document.getElementById('input').value.trim();
            const lines = input.split('\n').filter(l => l.trim() !== '');
            let outputHtmlContent = '';
            let leagueName = 'PREDIKSI TANPA JUDUL';
            let leagueData = {};
            const matchRegex = /^(\d{2}\/\d{2})\s+(\d{2}:\d{2})\s+WIB\s+(.+?)\s+vs\s+(.+?)\s+([0-9\s:/-]+)$/i;

            lines.forEach(line => {
                const match = line.match(matchRegex);
                if (match) {
                    const date = match[1];
                    const time = match[2];
                    const teamA = match[3].trim();
                    const teamB = match[4].trim();
                    const score = match[5].trim().replace(/\s*:\s*/g, ' - ');

                    if (!leagueData[leagueName]) leagueData[leagueName] = [];
                    leagueData[leagueName].push([
                        `${date} ${time} WIB`,
                        `${teamA} vs ${teamB}`,
                        score
                    ]);
                } else {
                    const tempLeagueName = line.trim().toUpperCase();
                    if (tempLeagueName !== '') {
                        leagueName = tempLeagueName;
                        if (!leagueData[leagueName]) leagueData[leagueName] = [];
                    }
                }
            });

            for (const name in leagueData) {
                if (leagueData[name].length > 0) {
                    outputHtmlContent += `
                        <div class="match-block">
                          <h3 class="league-title">${name}</h3>
                          <table>
                            <thead>
                              <tr>
                                <th>Tanggal & Waktu</th>
                                <th>Pertandingan</th>
                                <th>Skor</th>
                              </tr>
                            </thead>
                            <tbody>
                    `;
                    leagueData[name].forEach(match => {
                        outputHtmlContent += `
                            <tr>
                              <td>${match[0]}</td>
                              <td>${match[1]}</td>
                              <td>${match[2]}</td>
                            </tr>
                        `;
                    });
                    outputHtmlContent += `</tbody></table></div>`;
                }
            }

            document.getElementById('output').innerHTML = outputHtmlContent;
            document.getElementById('htmlOutput').value = outputHtmlContent;
        }

        function copyHTML() {
            const html = document.getElementById('htmlOutput');
            html.select();
            document.execCommand('copy');
            alert('Semua HTML berhasil disalin!');
        }

        // ==================== G. FUNGSI MANAJEMEN USER ====================
        
        function addNewStaff() {
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const messageDiv = document.getElementById('addUserMessage');
            
            messageDiv.style.color = 'red'; 
            messageDiv.textContent = '';

            if (username.length < 4 || password.length < 6) {
                messageDiv.textContent = 'Username minimal 4 karakter, Password minimal 6 karakter.';
                return;
            }

            let users = getUsers();
            if (users[username]) {
                messageDiv.textContent = 'Username sudah terdaftar.';
                return;
            }

            users[username] = { password: password, role: 'staf' };

            try {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
                messageDiv.style.color = 'green';
                messageDiv.textContent = `Staff ${username} berhasil ditambahkan!`;
                
                document.getElementById('newUserUsername').value = '';
                document.getElementById('newUserPassword').value = '';
                loadUserList(); 
            } catch (e) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = `‚ùå Gagal menyimpan data: ${e.name}. Coba lagi.`;
                console.error("LOCAL STORAGE ERROR:", e);
            }
        }

        function loadUserList() {
            const users = getUsers();
            const userListDiv = document.getElementById('user-list');

            let html = '<table>';
            html += '<thead><tr><th>Username</th><th>Peran (Role)</th><th>Aksi</th></tr></thead>';
            html += '<tbody>';

            for (const username in users) {
                const user = users[username];
                
                // PENTING: Cek jika format user masih string (dari error sebelumnya), pastikan itu Master
                let role = (typeof user === 'string') ? 'master' : user.role;
                
                const rowClass = role === 'master' ? 'class="master-role"' : '';
                
                html += `<tr ${rowClass}>`;
                html += `<td>${username}</td>`;
                html += `<td>${role.toUpperCase()}</td>`;
                html += `<td><button class="edit-user-btn" onclick="openEditForm('${username}')">Edit</button></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            userListDiv.innerHTML = html;
            
            document.getElementById('edit-form-container').style.display = 'none';
        }

        function openEditForm(username) {
            const users = getUsers();
            const user = users[username];
            
            if (!user) {
                alert('Pengguna tidak ditemukan.');
                return;
            }
            
            // PENTING: Handle kasus user format string yang seharusnya Master
            let role = (typeof user === 'string') ? 'master' : user.role;


            editingUsername = username; 
            
            document.getElementById('editing-username-display').textContent = username;
            document.getElementById('editRole').value = role;
            document.getElementById('editPassword').value = ''; 
            document.getElementById('editMessage').textContent = '';
            
            document.getElementById('edit-form-container').style.display = 'block';
        }

        function saveEditedUser() {
            if (!editingUsername) return;

            const newPassword = document.getElementById('editPassword').value.trim();
            const newRole = document.getElementById('editRole').value;
            const messageDiv = document.getElementById('editMessage');
            
            let users = getUsers();
            let userToEdit = users[editingUsername];

            if (!userToEdit) {
                 messageDiv.style.color = 'red';
                 messageDiv.textContent = 'Gagal menyimpan: Pengguna tidak ditemukan.';
                 return;
            }

            // Inisialisasi/koreksi format jika masih string
            if (typeof userToEdit === 'string') {
                 userToEdit = { password: userToEdit, role: 'master' };
            }
            
            // 1. Update Password (jika diisi)
            if (newPassword.length > 0) {
                if (newPassword.length < 6) {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = 'Password baru minimal 6 karakter.';
                    return;
                }
                userToEdit.password = newPassword;
            }

            // 2. Update Role
            userToEdit.role = newRole;

            // Simpan kembali ke localStorage
            users[editingUsername] = userToEdit;

            try {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
                messageDiv.style.color = 'green';
                messageDiv.textContent = `Data ${editingUsername} berhasil diperbarui!`;
                
                setTimeout(() => {
                    loadUserList(); 
                    document.getElementById('edit-form-container').style.display = 'none';
                    editingUsername = null;
                    
                    // Jika Master mengedit dirinya sendiri atau role-nya, perlu refresh status
                    if (editingUsername === localStorage.getItem('currentUsername')) {
                        checkLoginStatus(); 
                    }
                }, 1000);

            } catch (e) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = `‚ùå Gagal menyimpan data: ${e.name}. Coba lagi.`;
                console.error("LOCAL STORAGE ERROR:", e);
            }
        }
    </script>
</body>
</html>
